{% extends "base.html" %}

{% block title %}Compliance Reminders - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h4 mb-1">Compliance Reminders</h2>
            <p class="text-muted mb-0">Manage regulatory and custom deadlines for {{ company.name }}</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reminderModal" onclick="openCreateModal()">
            <i class="fas fa-plus me-2"></i>Add Reminder
        </button>
    </div>

    <!-- Filter Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-3">
                    <!-- Category Filters -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <span class="text-muted me-2">Category:</span>
                        <a href="{{ url_for('reminders.index', status=status_filter) }}" 
                           class="badge {{ 'bg-primary' if category_filter == 'all' else 'bg-light text-dark' }} text-decoration-none">
                            All <span class="ms-1">({{ category_counts.all }})</span>
                        </a>
                        <a href="{{ url_for('reminders.index', category='tax', status=status_filter) }}" 
                           class="badge {{ 'bg-danger' if category_filter == 'tax' else 'bg-light text-dark' }} text-decoration-none">
                            Tax <span class="ms-1">({{ category_counts.tax }})</span>
                        </a>
                        <a href="{{ url_for('reminders.index', category='payroll', status=status_filter) }}" 
                           class="badge {{ 'bg-warning' if category_filter == 'payroll' else 'bg-light text-dark' }} text-decoration-none">
                            Payroll <span class="ms-1">({{ category_counts.payroll }})</span>
                        </a>
                        <a href="{{ url_for('reminders.index', category='employment', status=status_filter) }}" 
                           class="badge {{ 'bg-info' if category_filter == 'employment' else 'bg-light text-dark' }} text-decoration-none">
                            Employment <span class="ms-1">({{ category_counts.employment }})</span>
                        </a>
                        <a href="{{ url_for('reminders.index', category='custom', status=status_filter) }}" 
                           class="badge {{ 'bg-secondary' if category_filter == 'custom' else 'bg-light text-dark' }} text-decoration-none">
                            Custom <span class="ms-1">({{ category_counts.custom }})</span>
                        </a>
                    </div>
                    
                    <!-- Status Filters -->
                    <div class="d-flex flex-wrap gap-2">
                        <span class="text-muted me-2">Status:</span>
                        <a href="{{ url_for('reminders.index', category=category_filter) }}" 
                           class="badge {{ 'bg-primary' if status_filter == 'all' else 'bg-light text-dark' }} text-decoration-none">
                            All
                        </a>
                        <a href="{{ url_for('reminders.index', category=category_filter, status='active') }}" 
                           class="badge {{ 'bg-success' if status_filter == 'active' else 'bg-light text-dark' }} text-decoration-none">
                            Active <span class="ms-1">({{ status_counts.active }})</span>
                        </a>
                        <a href="{{ url_for('reminders.index', category=category_filter, status='overdue') }}" 
                           class="badge {{ 'bg-danger' if status_filter == 'overdue' else 'bg-light text-dark' }} text-decoration-none">
                            Overdue <span class="ms-1">({{ status_counts.overdue }})</span>
                        </a>
                        <a href="{{ url_for('reminders.index', category=category_filter, status='upcoming') }}" 
                           class="badge {{ 'bg-warning' if status_filter == 'upcoming' else 'bg-light text-dark' }} text-decoration-none">
                            Due Soon <span class="ms-1">({{ status_counts.upcoming }})</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reminders List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    {% if reminders %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Recurring</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reminder in reminders %}
                                        <tr class="{{ 'table-danger' if reminder.is_overdue() else ('table-warning' if reminder.is_due_soon() else '') }}">
                                            <td>
                                                <div>
                                                    <strong>{{ reminder.title }}</strong>
                                                    {% if reminder.description %}
                                                        <br><small class="text-muted">{{ reminder.description[:100] }}{% if reminder.description|length > 100 %}...{% endif %}</small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% set category_colors = {'tax': 'danger', 'payroll': 'warning', 'employment': 'info', 'custom': 'secondary'} %}
                                                <span class="badge bg-{{ category_colors.get(reminder.category, 'secondary') }}">
                                                    {{ reminder.category.title() }}
                                                </span>
                                            </td>
                                            <td>
                                                <div>
                                                    {{ reminder.due_date.strftime('%d %b %Y') }}
                                                    {% set days_until = reminder.days_until_due() %}
                                                    {% if days_until is not none %}
                                                        <br><small class="text-muted">
                                                            {% if days_until < 0 %}
                                                                <span class="text-danger">{{ days_until|abs }} days overdue</span>
                                                            {% elif days_until == 0 %}
                                                                <span class="text-warning">Due today</span>
                                                            {% elif days_until <= 7 %}
                                                                <span class="text-warning">{{ days_until }} days remaining</span>
                                                            {% else %}
                                                                {{ days_until }} days remaining
                                                            {% endif %}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if reminder.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if reminder.is_recurring %}
                                                    <i class="fas fa-redo text-primary" title="Recurring: {{ reminder.recurrence_pattern }}"></i>
                                                    <small class="text-muted">{{ reminder.recurrence_pattern.title() if reminder.recurrence_pattern else 'Yes' }}</small>
                                                {% else %}
                                                    <span class="text-muted">No</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editReminder({{ reminder.id }})" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-{{ 'secondary' if reminder.is_active else 'success' }}" 
                                                            onclick="toggleReminder({{ reminder.id }})" 
                                                            title="{{ 'Deactivate' if reminder.is_active else 'Activate' }}">
                                                        <i class="fas fa-{{ 'pause' if reminder.is_active else 'play' }}"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteReminder({{ reminder.id }}, '{{ reminder.title }}')" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No reminders found</h5>
                            <p class="text-muted">
                                {% if category_filter != 'all' or status_filter != 'all' %}
                                    No reminders match your current filters.
                                {% else %}
                                    Get started by creating your first compliance reminder.
                                {% endif %}
                            </p>
                            {% if category_filter == 'all' and status_filter == 'all' %}
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reminderModal" onclick="openCreateModal()">
                                    <i class="fas fa-plus me-2"></i>Add First Reminder
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reminder Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reminderForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required maxlength="255">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="custom">Custom</option>
                                    <option value="tax">Tax</option>
                                    <option value="payroll">Payroll</option>
                                    <option value="employment">Employment</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Due Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="due_date" name="due_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reminder_days" class="form-label">Reminder Days</label>
                                <input type="text" class="form-control" id="reminder_days" name="reminder_days" 
                                       value="7,3,1" placeholder="7,3,1">
                                <div class="form-text">Comma-separated days before due date to show reminders</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="is_recurring" name="is_recurring">
                                <label class="form-check-label" for="is_recurring">
                                    Recurring Reminder
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3" id="recurrence_section" style="display: none;">
                                <label for="recurrence_pattern" class="form-label">Recurrence Pattern</label>
                                <select class="form-select" id="recurrence_pattern" name="recurrence_pattern">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="annually">Annually</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check" id="active_section">
                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Reminder</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let isEditMode = false;
let currentReminderId = null;
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Show/hide recurrence pattern based on checkbox
document.getElementById('is_recurring').addEventListener('change', function() {
    const recurrenceSection = document.getElementById('recurrence_section');
    recurrenceSection.style.display = this.checked ? 'block' : 'none';
});

function openCreateModal() {
    isEditMode = false;
    currentReminderId = null;
    document.querySelector('#reminderModal .modal-title').textContent = 'Add Reminder';
    document.getElementById('reminderForm').reset();
    document.getElementById('is_active').checked = true;
    document.getElementById('active_section').style.display = 'block';
    document.getElementById('recurrence_section').style.display = 'none';
}

function editReminder(reminderId) {
    isEditMode = true;
    currentReminderId = reminderId;
    document.querySelector('#reminderModal .modal-title').textContent = 'Edit Reminder';
    
    // Fetch reminder data
    fetch(`/reminders/${reminderId}/api`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Populate form
            document.getElementById('title').value = data.title || '';
            document.getElementById('description').value = data.description || '';
            document.getElementById('due_date').value = data.due_date || '';
            document.getElementById('category').value = data.category || 'custom';
            document.getElementById('reminder_days').value = Array.isArray(data.reminder_days) ? data.reminder_days.join(',') : '7,3,1';
            document.getElementById('is_recurring').checked = data.is_recurring || false;
            document.getElementById('recurrence_pattern').value = data.recurrence_pattern || 'monthly';
            document.getElementById('is_active').checked = data.is_active !== false;
            
            // Show/hide sections
            document.getElementById('recurrence_section').style.display = data.is_recurring ? 'block' : 'none';
            document.getElementById('active_section').style.display = 'block';
            
            // Show modal
            new bootstrap.Modal(document.getElementById('reminderModal')).show();
        })
        .catch(error => {
            console.error('Error fetching reminder:', error);
            alert('Failed to load reminder data');
        });
}

function deleteReminder(reminderId, title) {
    if (!confirm(`Are you sure you want to delete the reminder "${title}"?`)) {
        return;
    }
    
    fetch(`/reminders/${reminderId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete reminder'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete reminder');
    });
}

function toggleReminder(reminderId) {
    fetch(`/reminders/${reminderId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to toggle reminder'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to toggle reminder');
    });
}

// Handle form submission
document.getElementById('reminderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const url = isEditMode ? `/reminders/${currentReminderId}/edit` : '/reminders/create';
    
    fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('reminderModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to save reminder'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save reminder');
    });
});
</script>
{% endblock %}